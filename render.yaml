# Render.com ìµœì í™”ëœ ë°°í¬ ì„¤ì •
# ì˜¤ì„±ì¤‘í•™êµ ë™ì•„ë¦¬ í¸ì„± ì‹œìŠ¤í…œ v1.0.4
# Sleep ëª¨ë“œ ë°©ì§€ ë° ì„±ëŠ¥ ìµœì í™” í¬í•¨

services:
  # ë©”ì¸ ì›¹ ì„œë¹„ìŠ¤
  - type: web
    name: oseong-club-selection
    runtime: node
    plan: free  # ë¬´ë£Œ í”Œëœ
    region: singapore  # í•œêµ­ê³¼ ê°€ì¥ ê°€ê¹Œìš´ ì§€ì—­
    
    # ë¹Œë“œ ë° ì‹œì‘ ëª…ë ¹
    buildCommand: |
      echo "ğŸ”§ ë¹Œë“œ ì‹œì‘..."
      npm ci --only=production --no-audit --no-fund
      echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
      npm run system:info
      echo "âœ… ë¹Œë“œ ì™„ë£Œ"
      
    startCommand: |
      echo "ğŸš€ ì„œë²„ ì‹œì‘ ì¤€ë¹„..."
      export NODE_OPTIONS="--max-old-space-size=450 --expose-gc"
      npm start
      
    # í—¬ìŠ¤ì²´í¬ ì„¤ì • (Sleep ëª¨ë“œ ë°©ì§€ í•µì‹¬)
    healthCheckPath: /api/health
    
    # í™˜ê²½ ë³€ìˆ˜
    envVars:
      - key: NODE_ENV
        value: production
        
      - key: PORT
        value: 10000
        
      - key: JWT_SECRET
        generateValue: true  # ìë™ ìƒì„±
        
      - key: ADMIN_PASSWORD
        value: oseong2025!@#
        
      - key: INIT_KEY
        value: InitKey2025!@#
        
      - key: BCRYPT_SALT_ROUNDS
        value: 12
        
      - key: LOG_LEVEL
        value: info
        
      - key: RATE_LIMIT_MAX_REQUESTS
        value: 200  # ë¬´ë£Œ í”Œëœì—ì„œëŠ” ë” ê´€ëŒ€í•˜ê²Œ
        
      - key: RATE_LIMIT_WINDOW_MS
        value: 900000  # 15ë¶„
        
      - key: SKIP_HEALTH_CHECK
        value: false  # Productionì—ì„œëŠ” í—¬ìŠ¤ì²´í¬ í™œì„±í™”
        
      - key: HEALTH_CHECK_TIMEOUT
        value: 8000
        
      - key: HEALTH_CHECK_RETRIES
        value: 2
        
      - key: CORS_ORIGIN
        value: https://oseong-club-selection.onrender.com
        
    # ìë™ ë°°í¬ ì„¤ì •
    branch: main
    autoDeploy: true
    
    # ë¹Œë“œ í•„í„° (ë¶ˆí•„ìš”í•œ ì¬ë°°í¬ ë°©ì§€)
    buildFilter:
      paths:
        - server.js
        - package.json
        - package-lock.json
        - public/**
        - scripts/**
        - render.yaml
      ignoredPaths:
        - README.md
        - LICENSE
        - .gitignore
        - docs/**
        - "*.log"

# ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤
databases:
  - name: oseong-club-db
    databaseName: oseong_club_system
    user: oseong_admin
    plan: free  # ë¬´ë£Œ í”Œëœ (1GB)
    region: singapore
    
    # ë°±ì—… ì„¤ì •
    ipAllowList: []  # ëª¨ë“  IP í—ˆìš© (Render ë‚´ë¶€ ì ‘ê·¼ìš©)
    
# ì •ì  íŒŒì¼ í˜¸ìŠ¤íŒ… (ì„ íƒì‚¬í•­)
# static:
#   - name: oseong-assets
#     staticPublishPath: ./public
#     buildCommand: echo "ì •ì  íŒŒì¼ ë°°í¬"
#     branch: main
#     autoDeploy: true

# í™˜ê²½ë³„ ì„¤ì •
environments:
  production:
    # í”„ë¡œë•ì…˜ ìµœì í™” ì„¤ì •
    node_options: "--max-old-space-size=450 --expose-gc"
    memory_limit: 512
    cpu_limit: 0.1
    
    # Sleep ë°©ì§€ ì„¤ì •
    keep_alive:
      enabled: true
      interval: 840  # 14ë¶„ë§ˆë‹¤
      endpoint: "/keep-alive"
      
    # ëª¨ë‹ˆí„°ë§
    monitoring:
      enabled: true
      health_check: true
      memory_alerts: true
      error_tracking: true
      
    # ë³´ì•ˆ ì„¤ì •
    security:
      trust_proxy: true
      rate_limiting: true
      cors_enabled: true
      helmet_enabled: true
      
# ë¹Œë“œ í›„í¬
hooks:
  # ë°°í¬ ì „ ì‹¤í–‰
  preInstall: |
    echo "ğŸ“‹ ë°°í¬ ì „ ì¤€ë¹„..."
    echo "Node.js ë²„ì „: $(node --version)"
    echo "NPM ë²„ì „: $(npm --version)"
    echo "ë©”ëª¨ë¦¬ ì •ë³´: $(free -h 2>/dev/null || echo 'Memory info not available')"
    
  # ì„¤ì¹˜ í›„ ì‹¤í–‰
  postInstall: |
    echo "ğŸ” ì„¤ì¹˜ í›„ ê²€ì¦..."
    npm list --depth=0
    echo "ğŸ“Š íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
    
  # ë°°í¬ í›„ ì‹¤í–‰ (ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”)
  postDeploy: |
    echo "ğŸ¯ ë°°í¬ í›„ ì´ˆê¸°í™”..."
    sleep 10
    
    # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
    curl -f "$RENDER_EXTERNAL_URL/api/health" || echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
    
    # ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
    DB_STATUS=$(curl -s "$RENDER_EXTERNAL_URL/check-database" | grep -o '"database_status":"[^"]*"' | cut -d'"' -f4)
    echo "ğŸ“‚ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ: $DB_STATUS"
    
    if [ "$DB_STATUS" = "needs_initialization" ]; then
      echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘..."
      curl -f "$RENDER_EXTERNAL_URL/init-database?key=InitKey2025%21%40%23" || echo "âŒ DB ì´ˆê¸°í™” ì‹¤íŒ¨"
      echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ"
    else
      echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ë¯¸ ì¤€ë¹„ë¨"
    fi
    
    echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"

# ë„¤íŠ¸ì›Œí‚¹ ì„¤ì •
networking:
  # ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©
  allowedOrigins:
    - "*"  # CORSëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì²˜ë¦¬
    
  # í—¤ë” ì„¤ì •
  headers:
    - key: "X-Powered-By"
      value: "Oseong Middle School Club System"
    - key: "X-Content-Type-Options"
      value: "nosniff"
    - key: "X-Frame-Options"
      value: "SAMEORIGIN"

# ë¦¬ì†ŒìŠ¤ ì œí•œ (ë¬´ë£Œ í”Œëœ)
resources:
  cpu: 0.1    # 100m CPU
  memory: 512Mi # 512MB RAM
  disk: 1Gi   # 1GB ë””ìŠ¤í¬

# ìŠ¤ì¼€ì¼ë§ ì„¤ì • (ë¬´ë£Œ í”Œëœ)
scaling:
  minInstances: 1
  maxInstances: 1
  targetCPUPercent: 80
  targetMemoryPercent: 85

# ë¡œê¹… ì„¤ì •
logging:
  level: info
  format: json
  retention: 7  # 7ì¼ê°„ ë¡œê·¸ ë³´ê´€
  
  # ë¡œê·¸ í•„í„°
  filters:
    - path: "/favicon.ico"
      exclude: true
    - path: "/keep-alive"
      exclude: true
    - status: 200
      path: "/api/health"
      exclude: true

# ë°±ì—… ë° ë³µêµ¬ ì„¤ì •
backup:
  enabled: true
  schedule: "0 2 * * *"  # ë§¤ì¼ ì˜¤ì „ 2ì‹œ
  retention: 7           # 7ì¼ê°„ ë°±ì—… ë³´ê´€
  
# ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼
monitoring:
  # CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ëª¨ë‹ˆí„°ë§
  metrics:
    - type: cpu
      threshold: 90
      duration: 5m
      
    - type: memory
      threshold: 85
      duration: 3m
      
    - type: disk
      threshold: 95
      duration: 1m
  
  # í—¬ìŠ¤ì²´í¬ ëª¨ë‹ˆí„°ë§
  healthcheck:
    enabled: true
    interval: 30s
    timeout: 10s
    path: "/api/health"
    
    # Sleep ëª¨ë“œ ë°©ì§€ë¥¼ ìœ„í•œ ì¶”ê°€ í•‘
    keepalive:
      enabled: true
      interval: 14m
      path: "/keep-alive"

# ì„±ëŠ¥ ìµœì í™”
performance:
  # ì••ì¶• í™œì„±í™”
  compression: true
  
  # Keep-Alive ì—°ê²°
  keepAlive: true
  
  # ì •ì  íŒŒì¼ ìºì‹±
  staticCache:
    maxAge: 86400  # 1ì¼
    
  # í”„ë¡ì‹œ ì„¤ì •
  proxy:
    timeout: 30s
    keepalive: 60s
    
# ë³´ì•ˆ ì„¤ì •
security:
  # HTTPS ê°•ì œ
  forceHTTPS: true
  
  # ë³´ì•ˆ í—¤ë”
  headers:
    strictTransportSecurity: "max-age=31536000; includeSubDomains"
    contentSecurityPolicy: false  # ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì²˜ë¦¬
    xFrameOptions: "SAMEORIGIN"
    
# ê°œë°œì ì„¤ì •
developer:
  # ë””ë²„ê·¸ ëª¨ë“œ
  debug: false
  
  # ê°œë°œì ë„êµ¬
  tools:
    - name: "Health Monitor"
      url: "/api/health"
    - name: "System Status"  
      url: "/api/system-status"
    - name: "Database Status"
      url: "/check-database"
      
# ë¬¸ì„œí™”
docs:
  readme: "README.md"
  api: "/api/info"
  health: "/api/health"
  
# ë©”íƒ€ë°ì´í„°
metadata:
  project: "ì˜¤ì„±ì¤‘í•™êµ ë™ì•„ë¦¬ í¸ì„± ì‹œìŠ¤í…œ"
  version: "1.0.4"
  author: "ì˜¤ì„±ì¤‘í•™êµ"
  description: "2025í•™ë…„ë„ ì°½ì²´ë™ì•„ë¦¬ ì‹ ì²­ ë° í¸ì„± ê´€ë¦¬ ì‹œìŠ¤í…œ"
  tags:
    - "education"
    - "school-management" 
    - "club-selection"
    - "korean-school"
    - "render-optimized"
  
  # ì—°ë½ì²˜
  support:
    email: "support@oseong.school"
    github: "https://github.com/kkbhong71/oseong_club-selection"
    
  # ë¼ì´ì„ ìŠ¤
  license: "MIT"
  
  # ì—…ë°ì´íŠ¸ ì •ë³´
  lastUpdate: "2025-09-12"
  changelog: "Render.com ìµœì í™”, Sleep ëª¨ë“œ ë°©ì§€ ê¸°ëŠ¥ ì¶”ê°€"
