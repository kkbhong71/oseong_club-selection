# Render.com 최적화된 배포 설정
# 오성중학교 동아리 편성 시스템 v1.0.4
# Sleep 모드 방지 및 성능 최적화 포함

services:
  # 메인 웹 서비스
  - type: web
    name: oseong-club-selection
    runtime: node
    plan: free  # 무료 플랜
    region: singapore  # 한국과 가장 가까운 지역
    
    # 빌드 및 시작 명령
    buildCommand: |
      echo "🔧 빌드 시작..."
      npm ci --only=production --no-audit --no-fund
      echo "📦 의존성 설치 완료"
      npm run system:info
      echo "✅ 빌드 완료"
      
    startCommand: |
      echo "🚀 서버 시작 준비..."
      export NODE_OPTIONS="--max-old-space-size=450 --expose-gc"
      npm start
      
    # 헬스체크 설정 (Sleep 모드 방지 핵심)
    healthCheckPath: /api/health
    
    # 환경 변수
    envVars:
      - key: NODE_ENV
        value: production
        
      - key: PORT
        value: 10000
        
      - key: JWT_SECRET
        generateValue: true  # 자동 생성
        
      - key: ADMIN_PASSWORD
        value: oseong2025!@#
        
      - key: INIT_KEY
        value: InitKey2025!@#
        
      - key: BCRYPT_SALT_ROUNDS
        value: 12
        
      - key: LOG_LEVEL
        value: info
        
      - key: RATE_LIMIT_MAX_REQUESTS
        value: 200  # 무료 플랜에서는 더 관대하게
        
      - key: RATE_LIMIT_WINDOW_MS
        value: 900000  # 15분
        
      - key: SKIP_HEALTH_CHECK
        value: false  # Production에서는 헬스체크 활성화
        
      - key: HEALTH_CHECK_TIMEOUT
        value: 8000
        
      - key: HEALTH_CHECK_RETRIES
        value: 2
        
      - key: CORS_ORIGIN
        value: https://oseong-club-selection.onrender.com
        
    # 자동 배포 설정
    branch: main
    autoDeploy: true
    
    # 빌드 필터 (불필요한 재배포 방지)
    buildFilter:
      paths:
        - server.js
        - package.json
        - package-lock.json
        - public/**
        - scripts/**
        - render.yaml
      ignoredPaths:
        - README.md
        - LICENSE
        - .gitignore
        - docs/**
        - "*.log"

# 데이터베이스 서비스
databases:
  - name: oseong-club-db
    databaseName: oseong_club_system
    user: oseong_admin
    plan: free  # 무료 플랜 (1GB)
    region: singapore
    
    # 백업 설정
    ipAllowList: []  # 모든 IP 허용 (Render 내부 접근용)
    
# 정적 파일 호스팅 (선택사항)
# static:
#   - name: oseong-assets
#     staticPublishPath: ./public
#     buildCommand: echo "정적 파일 배포"
#     branch: main
#     autoDeploy: true

# 환경별 설정
environments:
  production:
    # 프로덕션 최적화 설정
    node_options: "--max-old-space-size=450 --expose-gc"
    memory_limit: 512
    cpu_limit: 0.1
    
    # Sleep 방지 설정
    keep_alive:
      enabled: true
      interval: 840  # 14분마다
      endpoint: "/keep-alive"
      
    # 모니터링
    monitoring:
      enabled: true
      health_check: true
      memory_alerts: true
      error_tracking: true
      
    # 보안 설정
    security:
      trust_proxy: true
      rate_limiting: true
      cors_enabled: true
      helmet_enabled: true
      
# 빌드 후크
hooks:
  # 배포 전 실행
  preInstall: |
    echo "📋 배포 전 준비..."
    echo "Node.js 버전: $(node --version)"
    echo "NPM 버전: $(npm --version)"
    echo "메모리 정보: $(free -h 2>/dev/null || echo 'Memory info not available')"
    
  # 설치 후 실행
  postInstall: |
    echo "🔍 설치 후 검증..."
    npm list --depth=0
    echo "📊 패키지 설치 완료"
    
  # 배포 후 실행 (데이터베이스 초기화)
  postDeploy: |
    echo "🎯 배포 후 초기화..."
    sleep 10
    
    # 서비스 상태 확인
    curl -f "$RENDER_EXTERNAL_URL/api/health" || echo "⚠️ 헬스체크 실패"
    
    # 데이터베이스 상태 확인 및 초기화
    DB_STATUS=$(curl -s "$RENDER_EXTERNAL_URL/check-database" | grep -o '"database_status":"[^"]*"' | cut -d'"' -f4)
    echo "📂 데이터베이스 상태: $DB_STATUS"
    
    if [ "$DB_STATUS" = "needs_initialization" ]; then
      echo "🔄 데이터베이스 초기화 중..."
      curl -f "$RENDER_EXTERNAL_URL/init-database?key=InitKey2025%21%40%23" || echo "❌ DB 초기화 실패"
      echo "✅ 데이터베이스 초기화 완료"
    else
      echo "✅ 데이터베이스 이미 준비됨"
    fi
    
    echo "🎉 배포 완료!"

# 네트워킹 설정
networking:
  # 외부 접근 허용
  allowedOrigins:
    - "*"  # CORS는 애플리케이션에서 처리
    
  # 헤더 설정
  headers:
    - key: "X-Powered-By"
      value: "Oseong Middle School Club System"
    - key: "X-Content-Type-Options"
      value: "nosniff"
    - key: "X-Frame-Options"
      value: "SAMEORIGIN"

# 리소스 제한 (무료 플랜)
resources:
  cpu: 0.1    # 100m CPU
  memory: 512Mi # 512MB RAM
  disk: 1Gi   # 1GB 디스크

# 스케일링 설정 (무료 플랜)
scaling:
  minInstances: 1
  maxInstances: 1
  targetCPUPercent: 80
  targetMemoryPercent: 85

# 로깅 설정
logging:
  level: info
  format: json
  retention: 7  # 7일간 로그 보관
  
  # 로그 필터
  filters:
    - path: "/favicon.ico"
      exclude: true
    - path: "/keep-alive"
      exclude: true
    - status: 200
      path: "/api/health"
      exclude: true

# 백업 및 복구 설정
backup:
  enabled: true
  schedule: "0 2 * * *"  # 매일 오전 2시
  retention: 7           # 7일간 백업 보관
  
# 모니터링 및 알림
monitoring:
  # CPU/메모리 사용률 모니터링
  metrics:
    - type: cpu
      threshold: 90
      duration: 5m
      
    - type: memory
      threshold: 85
      duration: 3m
      
    - type: disk
      threshold: 95
      duration: 1m
  
  # 헬스체크 모니터링
  healthcheck:
    enabled: true
    interval: 30s
    timeout: 10s
    path: "/api/health"
    
    # Sleep 모드 방지를 위한 추가 핑
    keepalive:
      enabled: true
      interval: 14m
      path: "/keep-alive"

# 성능 최적화
performance:
  # 압축 활성화
  compression: true
  
  # Keep-Alive 연결
  keepAlive: true
  
  # 정적 파일 캐싱
  staticCache:
    maxAge: 86400  # 1일
    
  # 프록시 설정
  proxy:
    timeout: 30s
    keepalive: 60s
    
# 보안 설정
security:
  # HTTPS 강제
  forceHTTPS: true
  
  # 보안 헤더
  headers:
    strictTransportSecurity: "max-age=31536000; includeSubDomains"
    contentSecurityPolicy: false  # 애플리케이션에서 처리
    xFrameOptions: "SAMEORIGIN"
    
# 개발자 설정
developer:
  # 디버그 모드
  debug: false
  
  # 개발자 도구
  tools:
    - name: "Health Monitor"
      url: "/api/health"
    - name: "System Status"  
      url: "/api/system-status"
    - name: "Database Status"
      url: "/check-database"
      
# 문서화
docs:
  readme: "README.md"
  api: "/api/info"
  health: "/api/health"
  
# 메타데이터
metadata:
  project: "오성중학교 동아리 편성 시스템"
  version: "1.0.4"
  author: "오성중학교"
  description: "2025학년도 창체동아리 신청 및 편성 관리 시스템"
  tags:
    - "education"
    - "school-management" 
    - "club-selection"
    - "korean-school"
    - "render-optimized"
  
  # 연락처
  support:
    email: "support@oseong.school"
    github: "https://github.com/kkbhong71/oseong_club-selection"
    
  # 라이선스
  license: "MIT"
  
  # 업데이트 정보
  lastUpdate: "2025-09-12"
  changelog: "Render.com 최적화, Sleep 모드 방지 기능 추가"
