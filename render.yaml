# Render.com ë°°í¬ ì„¤ì • íŒŒì¼ (ìµœì í™”ë¨)
# ì˜¤ì„±ì¤‘í•™êµ ë™ì•„ë¦¬ í¸ì„± ì‹œìŠ¤í…œ v1.0.1
services:
  # ì›¹ ì„œë¹„ìŠ¤ (Node.js + Express + React)
  - type: web
    name: oseong-club-system
    env: node
    plan: starter  # ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ starter í”Œëœ ê¶Œì¥ (ë¬´ë£Œ í”Œëœë„ ê°€ëŠ¥)
    region: singapore  # í•œêµ­ê³¼ ê°€ì¥ ê°€ê¹Œìš´ ì§€ì—­
    
    # ë¹Œë“œ ì„¤ì • (ìµœì í™”ë¨)
    buildCommand: |
      echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date)"
      npm ci --only=production
      echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
      echo "âœ… ë¹Œë“œ ì™„ë£Œ: $(date)"
    
    # ì‹œì‘ ëª…ë ¹ì–´
    startCommand: npm start
    
    # í—¬ìŠ¤ì²´í¬ ì„¤ì • (ê°œì„ ë¨)
    healthCheckPath: /api/health
    
    # í™˜ê²½ ë³€ìˆ˜ (ë³´ì•ˆ ê°•í™”)
    envVars:
      - key: NODE_ENV
        value: production
      - key: JWT_SECRET
        generateValue: true  # ìë™ìœ¼ë¡œ ì•ˆì „í•œ ëœë¤ ê°’ ìƒì„±
      - key: ADMIN_PASSWORD
        generateValue: true  # ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ìë™ ìƒì„±
      - key: BCRYPT_SALT_ROUNDS
        value: "12"  # ë³´ì•ˆ ê°•í™”
      - key: MAX_FILE_SIZE
        value: "10"
      - key: RATE_LIMIT_WINDOW_MS
        value: "900000"  # 15ë¶„
      - key: RATE_LIMIT_MAX_REQUESTS
        value: "100"
      - key: SESSION_SECRET
        generateValue: true
      - key: INIT_KEY
        generateValue: true  # DB ì´ˆê¸°í™” ë³´ì•ˆ í‚¤
      - key: LOG_LEVEL
        value: "info"
      - key: CORS_ORIGIN
        value: "https://oseong-club-selection.onrender.com"
        
    # ìë™ ë°°í¬ ì„¤ì •
    autoDeploy: true
    branch: main
    
    # ë””ìŠ¤í¬ ìš©ëŸ‰ (ë¬´ë£Œ: 1GB, ìœ ë£Œ: ë” ë§ìŒ)
    disk:
      name: oseong-club-disk
      mountPath: /tmp
      sizeGB: 1
    
# PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ (ìµœì í™”ë¨)
databases:
  - name: oseong-club-db
    databaseName: oseong_club_db
    user: oseong_admin
    plan: free  # ë¬´ë£Œ í”Œëœ (1GB ìŠ¤í† ë¦¬ì§€)
    region: singapore  # ì›¹ ì„œë¹„ìŠ¤ì™€ ê°™ì€ ì§€ì—­
    version: "15"  # PostgreSQL ìµœì‹  ë²„ì „
    
    # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
    ipAllowList: []  # ëª¨ë“  IP í—ˆìš© (Render ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬)
    
# ë¹Œë“œ ë° ë°°í¬ í›„í¬ (ê°œì„ ë¨)
hooks:
  # ë°°í¬ ì „ ì¤€ë¹„
  preDeploy:
    - name: pre-deploy-check
      command: |
        echo "ğŸ” ë°°í¬ ì „ ê²€ì‚¬ ì‹œì‘"
        echo "Node.js ë²„ì „: $(node --version)"
        echo "npm ë²„ì „: $(npm --version)"
        echo "ë©”ëª¨ë¦¬ ìƒíƒœ: $(free -h || echo 'N/A')"
        echo "ë””ìŠ¤í¬ ìƒíƒœ: $(df -h || echo 'N/A')"
        
  # ë°°í¬ í›„ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
  postDeploy:
    - name: database-initialization
      command: |
        echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹œì‘"
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
        timeout 30 bash -c 'until pg_isready -h $DATABASE_HOST -p $DATABASE_PORT -U $DATABASE_USER; do echo "DB ì—°ê²° ëŒ€ê¸°..."; sleep 2; done'
        
        if [ "$RENDER_SERVICE_TYPE" = "web" ]; then
          echo "ì›¹ ì„œë¹„ìŠ¤ ë°°í¬ - DB ìƒíƒœ í™•ì¸"
          
          # í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          TABLE_COUNT=$(psql $DATABASE_URL -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';" | tr -d ' ')
          
          if [ "$TABLE_COUNT" -eq "0" ]; then
            echo "ğŸ†• ì²« ë°°í¬ - ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤í–‰"
            
            # í—¬ìŠ¤ì²´í¬ê°€ ì„±ê³µí•  ë•Œê¹Œì§€ ëŒ€ê¸°
            timeout 60 bash -c 'until curl -f http://localhost:$PORT/api/health; do echo "ì„œë²„ ì‹œì‘ ëŒ€ê¸°..."; sleep 5; done'
            
            # DB ì´ˆê¸°í™” ì‹¤í–‰
            curl -f "http://localhost:$PORT/init-database?key=$INIT_KEY" || {
              echo "âŒ DB ì´ˆê¸°í™” ì‹¤íŒ¨"
              exit 1
            }
            
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ"
          else
            echo "ğŸ“Š ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ê°ì§€ - ë§ˆì´ê·¸ë ˆì´ì…˜ í™•ì¸"
            
            # í–¥í›„ ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ ì¶”ê°€
            echo "ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” ì‹œ ì—¬ê¸°ì— ì½”ë“œ ì¶”ê°€"
          fi
        fi
        
        echo "ğŸ‰ ë°°í¬ í›„ ì‘ì—… ì™„ë£Œ"

# ì •ì  íŒŒì¼ ë° ìºì‹± ì„¤ì •
headers:
  # ë³´ì•ˆ í—¤ë”
  - source: "/*"
    headers:
      X-Frame-Options: "DENY"
      X-Content-Type-Options: "nosniff"
      Referrer-Policy: "strict-origin-when-cross-origin"
      Permissions-Policy: "geolocation=(), microphone=(), camera=()"
      
  # ì •ì  íŒŒì¼ ìºì‹±
  - source: "/static/*"
    headers:
      Cache-Control: "public, max-age=31536000, immutable"
      
  - source: "*.js"
    headers:
      Cache-Control: "public, max-age=31536000"
      
  - source: "*.css"
    headers:
      Cache-Control: "public, max-age=31536000"
      
  - source: "*.png"
    headers:
      Cache-Control: "public, max-age=31536000"
      
  - source: "*.jpg"
    headers:
      Cache-Control: "public, max-age=31536000"

# í—¬ìŠ¤ì²´í¬ ë° ëª¨ë‹ˆí„°ë§ (ê°•í™”ë¨)
healthCheck:
  path: /api/health
  intervalSeconds: 30
  timeoutSeconds: 10
  unhealthyThresholdCount: 3
  healthyThresholdCount: 2
  
# ë¡œê·¸ ì„¤ì • (êµ¬ì¡°í™”ë¨)
logging:
  level: info
  format: combined  # Apache í˜¸í™˜ ë¡œê·¸ í˜•ì‹
  
# ë¦¬ì†ŒìŠ¤ ì œí•œ ë° ìŠ¤ì¼€ì¼ë§
resources:
  cpu: 0.25    # 250m CPU (ë¬´ë£Œ: 0.1, ìŠ¤íƒ€í„°: 0.25)
  memory: 512Mi # 512MB RAM (ë¬´ë£Œ: 512Mi, ìŠ¤íƒ€í„°: 1Gi)
  
# ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •
scaling:
  minInstances: 1
  maxInstances: 2  # ë¬´ë£Œ í”Œëœ: 1, ìœ ë£Œ í”Œëœ: í™•ì¥ ê°€ëŠ¥
  targetCPUPercent: 70
  targetMemoryPercent: 80
  
# ë„¤íŠ¸ì›Œí¬ ì„¤ì • (ë³´ì•ˆ ê°•í™”)
networking:
  allowedOrigins:
    - "https://oseong-club-selection.onrender.com"
    - "https://osung-club-system.onrender.com"
    
# ë°±ì—… ë° ì¬í•´ ë³µêµ¬
backup:
  enabled: true
  retention: 7  # 7ì¼ê°„ ë°±ì—… ë³´ê´€
  schedule: "0 2 * * *"  # ë§¤ì¼ ì˜¤ì „ 2ì‹œ ë°±ì—…
  
# ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ (ê°•í™”ë¨)
monitoring:
  enabled: true
  alerts:
    - type: cpu
      threshold: 80
      duration: 300  # 5ë¶„
    - type: memory  
      threshold: 85
      duration: 300
    - type: disk
      threshold: 90
      duration: 60   # 1ë¶„
    - type: response_time
      threshold: 5000  # 5ì´ˆ
      duration: 180    # 3ë¶„
    - type: error_rate
      threshold: 10    # 10%
      duration: 300
      
# ë³´ì•ˆ ì„¤ì • (ì¶”ê°€)
security:
  # IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (í•„ìš” ì‹œ)
  ipAllowList: []
  
  # DDoS ë³´í˜¸
  ddosProtection:
    enabled: true
    rateLimit: 100
    
  # SSL/TLS ì„¤ì •
  ssl:
    enforceHttps: true
    minTlsVersion: "1.2"
    
# ê°œë°œ ë° ìŠ¤í…Œì´ì§• í™˜ê²½ (ì„ íƒì‚¬í•­)
environments:
  - name: staging
    branch: develop
    envVars:
      - key: NODE_ENV
        value: staging
      - key: LOG_LEVEL
        value: debug
        
  - name: production
    branch: main
    envVars:
      - key: NODE_ENV
        value: production
      - key: LOG_LEVEL
        value: info

# ë¹„ìš© ìµœì í™” ì„¤ì •
costOptimization:
  # ìœ íœ´ ì‹œê°„ ìŠ¬ë¦½ (ë¬´ë£Œ í”Œëœ)
  sleepAfterInactivity: 15  # 15ë¶„ ë¹„í™œì„± í›„ ìŠ¬ë¦½
  
  # ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
  resourceAlerts:
    enabled: true
    cpuThreshold: 90
    memoryThreshold: 90
    
# ë°°í¬ ì „ëµ
deployment:
  strategy: rolling  # ë¬´ì¤‘ë‹¨ ë°°í¬
  maxSurge: 1
  maxUnavailable: 0
  
  # ë¡¤ë°± ì„¤ì •
  rollback:
    enabled: true
    revisionHistoryLimit: 5
    
# ì»¤ìŠ¤í…€ ë„ë©”ì¸ (ì„ íƒì‚¬í•­)
# domains:
#   - name: "club.oseong.school"
#     certificateId: "cert-xxx"

# í™˜ê²½ë³„ ì„¤ì • íŒŒì¼
configs:
  - name: app-config
    files:
      - source: ./config/production.json
        destination: /app/config.json
